# 🌱 作物病害检测系统 - 完整使用指南

## 📋 目录

1. [系统概述](#系统概述)
2. [环境要求](#环境要求)
3. [安装部署](#安装部署)
4. [启动服务](#启动服务)
5. [功能使用](#功能使用)
6. [API 接口文档](#api-接口文档)
7. [常见问题](#常见问题)
8. [技术支持](#技术支持)

---

## 🎯 系统概述

本系统是一个基于 **YOLO 深度学习模型** 和 **DeepSeek AI** 的作物病害智能检测系统，能够：

- 🔍 **智能识别**：自动识别 39 种作物病害
- 📊 **精准分析**：提供病害置信度评分
- 💡 **治疗建议**：基于 AI 生成专业治疗方案
- 📈 **历史追踪**：记录所有检测历史，支持数据分析

### 支持的作物类型

| 作物 | 病害数量 | 示例病害 |
|------|----------|----------|
| 🍎 苹果 | 4 | 黑星病、黑腐病、雪松苹果锈病 |
| 🍇 葡萄 | 4 | 黑腐病、白粉病、轮斑病 |
| 🍅 番茄 | 10 | 细菌性斑点病、早疫病、晚疫病、黄叶曲病 |
| 🌽 玉米 | 4 | 灰斑病、普通锈病、北方叶枯病 |
| 🥔 土豆 | 3 | 早疫病、晚疫病 |
| 🍓 草莓 | 2 | 叶焦病 |
| 🍒 樱桃 | 2 | 白粉病 |
| 🌶️ 辣椒 | 2 | 细菌性斑点病 |
| 其他 | 8+ | 柑橘、大豆、南瓜、树莓等 |

---

## 💻 环境要求

### 必需环境

| 软件 | 版本要求 | 用途 |
|------|----------|------|
| **Python** | 3.8+ (推荐 3.10+) | AI 服务运行 |
| **Java JDK** | 17+ (推荐 21) | 后端服务运行 |
| **Maven** | 3.6+ | Java 项目构建 |

### 可选环境

| 软件 | 版本要求 | 用途 |
|------|----------|------|
| Node.js | 16+ | 前端开发 |
| MySQL | 8.0+ | 生产数据库 |
| Docker | 20+ | 容器化部署 |

### 硬件建议

- **CPU**: 4 核心以上
- **内存**: 8GB 以上（AI 模型需要较多内存）
- **硬盘**: 2GB 可用空间
- **GPU**: 可选，有 NVIDIA GPU 可加速检测

---

## 📥 安装部署

### 步骤 1：克隆项目

```bash
# 下载项目到本地
git clone <项目地址>
cd 毕业设计
```

### 步骤 2：安装 Python 依赖

```powershell
# 进入 AI 服务目录
cd ai-service

# 创建虚拟环境（推荐）
python -m venv venv

# 激活虚拟环境
.\venv\Scripts\activate    # Windows PowerShell
# source venv/bin/activate # Linux/Mac

# 安装依赖包
pip install -r requirements.txt
```

**主要依赖包**：
- `flask` - Web 框架
- `ultralytics` - YOLO 模型
- `torch` - 深度学习框架
- `opencv-python` - 图像处理
- `Pillow` - 图像处理

### 步骤 3：配置后端服务

```powershell
# 进入后端目录
cd backend

# Maven 会自动下载依赖
mvn clean install -DskipTests
```

**配置文件** (`backend/src/main/resources/application.properties`)：

```properties
# 服务端口
server.port=8080

# AI 服务地址
ai.service.url=http://localhost:5000

# 数据库配置（开发环境使用 H2 内存数据库）
spring.datasource.url=jdbc:h2:mem:cropdisease
```

---

## 🚀 启动服务

### 方式一：分别启动（推荐开发时使用）

#### 1. 启动 AI 服务

```powershell
# 终端 1
cd ai-service
python app_production.py
```

看到以下输出表示启动成功：
```
🌱 作物病害检测AI服务
==================================================
📦 模型状态: ✅ 已加载
🎯 支持类别: 39 个
🚀 服务启动中...
 * Running on http://127.0.0.1:5000
```

#### 2. 启动后端服务

```powershell
# 终端 2
cd backend
mvn spring-boot:run
```

看到以下输出表示启动成功：
```
🌱 作物病害检测系统启动成功!
📡 API地址: http://localhost:8080
🔍 健康检查: http://localhost:8080/api/system/health
```

### 方式二：一键启动脚本

```powershell
# 运行启动脚本
.\scripts\setup-environment.bat
```

### 服务状态检查

| 服务 | 地址 | 说明 |
|------|------|------|
| AI 服务 | http://localhost:5000 | YOLO 检测界面 |
| 后端 API | http://localhost:8080 | Spring Boot API |
| 健康检查 | http://localhost:8080/api/system/health | 系统状态 |
| H2 控制台 | http://localhost:8080/h2-console | 数据库管理 |

---

## 📖 功能使用

### 1. 病害检测（Web 界面）

1. 打开浏览器访问 `http://localhost:5000`
2. 点击 **选择图片** 或拖拽图片到上传区域
3. 点击 **开始检测** 按钮
4. 查看检测结果：
   - 病害名称
   - 置信度百分比
   - 治疗建议

### 2. 病害检测（API 调用）

```bash
# 使用 curl 调用检测接口
curl -X POST http://localhost:5000/detect \
  -F "image=@你的图片.jpg"
```

**返回示例**：
```json
{
  "success": true,
  "predictions": [
    {
      "class_name": "Apple___Apple_scab",
      "class_name_cn": "苹果黑星病",
      "confidence": 0.95,
      "crop_type": "苹果",
      "disease_name": "黑星病",
      "recommendations": "1. 清除病叶病果..."
    }
  ]
}
```

### 3. 用户管理

#### 注册用户
```bash
curl -X POST http://localhost:8080/api/users \
  -H "Content-Type: application/json" \
  -d '{
    "username": "farmer1",
    "password": "123456",
    "email": "farmer1@example.com",
    "realName": "张三"
  }'
```

#### 用户登录
```bash
curl -X POST http://localhost:8080/api/users/login \
  -H "Content-Type: application/json" \
  -d '{
    "username": "farmer1",
    "password": "123456"
  }'
```

### 4. 检测记录管理

#### 获取所有检测记录
```bash
curl http://localhost:8080/api/detections
```

#### 获取用户检测记录
```bash
curl http://localhost:8080/api/detections/user/1
```

---

## 📚 API 接口文档

### AI 服务接口 (端口 5000)

| 接口 | 方法 | 说明 |
|------|------|------|
| `/` | GET | 检测界面首页 |
| `/health` | GET | 健康检查 |
| `/detect` | POST | 图片检测 |
| `/detect_base64` | POST | Base64 图片检测 |
| `/api/classes` | GET | 获取支持的类别列表 |

### 后端服务接口 (端口 8080)

#### 系统接口
| 接口 | 方法 | 说明 |
|------|------|------|
| `/api/system/health` | GET | 系统健康检查 |
| `/api/system/info` | GET | 系统信息 |

#### 用户接口
| 接口 | 方法 | 说明 |
|------|------|------|
| `/api/users` | GET | 获取所有用户 |
| `/api/users/{id}` | GET | 获取指定用户 |
| `/api/users` | POST | 创建用户 |
| `/api/users/login` | POST | 用户登录 |
| `/api/users/{id}` | PUT | 更新用户 |
| `/api/users/{id}` | DELETE | 删除用户 |

#### 检测记录接口
| 接口 | 方法 | 说明 |
|------|------|------|
| `/api/detections` | GET | 获取所有记录 |
| `/api/detections/{id}` | GET | 获取指定记录 |
| `/api/detections/user/{userId}` | GET | 获取用户记录 |
| `/api/detections/recent` | GET | 获取最近记录 |
| `/api/detections` | POST | 创建检测记录 |

---

## ❓ 常见问题

### Q1: AI 服务启动失败，提示缺少依赖？

**解决方案**：
```powershell
pip install torch torchvision ultralytics flask flask-cors opencv-python Pillow
```

### Q2: 后端服务端口被占用？

**解决方案**：
1. 修改 `application.properties` 中的端口：
   ```properties
   server.port=8081
   ```
2. 或关闭占用端口的程序：
   ```powershell
   netstat -ano | findstr :8080
   taskkill /PID <进程ID> /F
   ```

### Q3: 检测结果不准确？

**可能原因**：
- 图片质量不佳（模糊、光线不足）
- 图片中叶片不清晰
- 病害不在支持的 39 种类别中

**建议**：
- 拍摄清晰的叶片特写图片
- 确保光线充足
- 对准病害部位拍摄

### Q4: 数据库数据丢失？

开发环境使用 H2 内存数据库，重启后数据会清空。生产环境建议配置 MySQL：

```properties
spring.datasource.url=jdbc:mysql://localhost:3306/cropdisease
spring.datasource.username=root
spring.datasource.password=your_password
spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver
spring.jpa.database-platform=org.hibernate.dialect.MySQLDialect
```

### Q5: GPU 加速如何启用？

确保安装了 CUDA 版本的 PyTorch：
```powershell
pip install torch torchvision --index-url https://download.pytorch.org/whl/cu118
```

---

## 📞 技术支持

如有问题，请参考以下资源：

- 📖 项目文档：`docs/` 目录
- 🐛 问题反馈：提交 Issue
- 📧 联系作者：[您的邮箱]

---

## 📄 版本历史

| 版本 | 日期 | 更新内容 |
|------|------|----------|
| v1.0.0 | 2025-11-27 | 初始版本，支持 39 种病害检测 |

---

*最后更新：2025年11月27日*
